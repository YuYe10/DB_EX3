# 教师端成绩编辑功能 - 快速参考

## 功能概览
老师现在可以在老师界面修改学生的平时成绩和期末成绩，并自定义比例。系统会自动计算最终成绩。

## 使用流程

### 1. 登录系统
- 使用教师账号登录系统

### 2. 进入"我的授课"
- 在教师界面的"📖 我的授课"部分选择授课课程

### 3. 编辑学生成绩
- 在学生列表中找到要编辑的学生
- 点击该学生行的 **"编辑成绩"** 按钮
- 该行会展开显示成绩编辑面板

### 4. 输入成绩
编辑面板包含四个输入项：
- **平时成绩 (0-100)**：学生的日常成绩
- **期末成绩 (0-100)**：学生的期末考试成绩
- **平时占比**：平时成绩在总成绩中的权重（0-1）
- **期末占比**：期末成绩在总成绩中的权重（0-1）

### 5. 自动占比计算
- 修改任一占比后，另一占比会自动调整
- 系统保证占比和永远等于 1.0
- 显示 **"占比和"** 验证当前占比正确性

### 6. 预览最终成绩
- 系统实时显示 **"预计最终成绩"**
- 公式：最终成绩 = 平时成绩 × 平时占比 + 期末成绩 × 期末占比
- 最终成绩精确到小数点后一位

### 7. 保存成绩
- 点击 **"✓ 保存"** 按钮保存成绩
- 系统会验证占比和是否为 1.0
- 如果占比和不符合要求，会提示错误

### 8. 取消编辑
- 点击 **"取消"** 按钮可关闭编辑面板
- 不保存任何更改

### 9. 导出成绩
- 在课程操作栏点击 **"导出成绩Excel"** 按钮
- 系统会导出包含最终成绩的 Excel 文件
- 文件名格式：`{课程名}-{教师名}-{时间戳}.xlsx`

## 数据结构

### 请求格式 (PUT /api/teacher/enrollments/{id}/grades)
```json
{
  "ordinary_score": 80,      // 平时成绩，必填 (0-100)
  "final_score": 85,         // 期末成绩，必填 (0-100)
  "ordinary_weight": 0.4,    // 平时占比，必填 (0-1)
  "final_weight": 0.6        // 期末占比，必填 (0-1)
}
```

### 数据库存储
```
enrollments 表新字段：
- ordinary_score: 平时成绩 (NUMERIC)
- final_score: 期末成绩 (NUMERIC)
- ordinary_weight: 平时占比 (NUMERIC)
- final_weight: 期末占比 (NUMERIC)
- final_grade: 最终成绩 (NUMERIC) - 自动计算
- grade: 历史成绩字段（保留用于向后兼容）
```

## 系统特性

### 权限控制
- 教师只能修改其所教课程的学生成绩
- 无法访问其他教师的课程数据
- 系统在更新前验证权限

### 数据一致性
- 占比必须和为 1.0（允许误差 ±0.01）
- 成绩必须在 0-100 范围内
- 最终成绩自动计算，无需手动输入

### 向后兼容性
- 系统支持旧数据（可能只有 `grade` 字段）
- 导出和显示时会自动使用最终成绩，如果没有则使用历史成绩
- 课程平均分计算也采用同样的兼容性处理

## 错误处理

| 错误 | 原因 | 解决方案 |
|------|------|--------|
| "占比和必须等于 1" | 两个占比相加不等于 1.0 | 调整占比，系统会自动计算 |
| "权限检查失败" | 不是该课程的授课教师 | 确认登录的是正确的教师账户 |
| "成绩必须在0-100之间" | 输入的成绩超出范围 | 输入 0-100 之间的数字 |
| "更新失败" | 网络或服务器错误 | 检查网络连接，稍后重试 |

## 常见操作

### 快速设置常用占比

**方案1：平时40%，期末60%**
1. 平时占比输入 0.4（会自动计算期末占比为 0.6）
2. 输入平时和期末成绩
3. 保存

**方案2：平时50%，期末50%**
1. 平时占比输入 0.5（会自动计算期末占比为 0.5）
2. 输入平时和期末成绩
3. 保存

**方案3：平时33%，期末67%**
1. 平时占比输入 0.33（会自动计算期末占比为 0.67）
2. 输入平时和期末成绩
3. 保存

## 技术细节

### 前端实现
- Vue 3 组件：TeacherView.vue
- 使用 `ref({})` 管理可扩展编辑器状态
- 实时预览使用纯 JavaScript 计算
- HTTP 客户端：Fetch API

### 后端实现
- API 端点：`PUT /api/teacher/enrollments/{id}/grades`
- 认证：基于 session 的教师身份验证
- 权限验证：确保教师拥有该课程
- 业务逻辑：委托给 AdminService 处理

### 数据流
```
前端表单输入 → 占比和验证 → 成绩预览计算 
  → 点击保存 → API 请求 
  → 后端权限验证 → 业务逻辑处理 
  → 数据库更新 → 响应前端 
  → 刷新学生列表显示
```

## 浏览器兼容性
- Chrome 90+
- Firefox 88+
- Safari 14+
- Edge 90+

## 性能
- 单次成绩更新：~200-500ms（含网络延迟）
- 列表刷新：~1-2s（根据学生数量）
- 前端实时预览：无延迟（纯 JS 计算）

## 常见问题

### Q: 为什么修改占比后，另一个占比会自动变化？
A: 系统要求两个占比的和必须等于 1.0。当你修改一个占比时，系统会自动调整另一个占比以满足这个要求。

### Q: 如果输入的占比和不等于 1.0，保存会失败吗？
A: 是的，系统会在保存前检查占比和是否为 1.0（允许误差 ±0.01）。如果不符合要求，会显示错误提示。

### Q: 平时和期末成绩可以相同吗？
A: 可以的。系统没有限制两个成绩的相对大小，你可以根据实际情况输入任何 0-100 之间的数值。

### Q: 导出的 Excel 中会显示什么？
A: 导出的 Excel 会显示学生的基本信息（学号、姓名、专业）和最终成绩。如果某个学生还没有评分，会显示空值。

### Q: 可以批量更新成绩吗？
A: 当前系统支持逐个更新。如果需要批量操作，可以通过上传课程名单 Excel 来实现（需要在 Excel 中包含成绩数据）。

### Q: 修改了成绩但没有保存，数据会丢失吗？
A: 是的，如果只输入了数据但没有点击保存按钮，或者点击了取消按钮，所有更改都会丢失。

### Q: 占比精度是多少？
A: 占比保留到小数点后两位。最终成绩计算后显示小数点后一位。

## 后续维护

如需对此功能进行修改或扩展，请参考以下文件：

**后端**：
- `/backend/app_core/api/teacher.py` - API 路由
- `/backend/app_core/services/teacher_service.py` - 业务逻辑

**前端**：
- `/frontend/vue/src/components/TeacherView.vue` - UI 组件

**数据库**：
- 表结构在 `db.py` 中定义
- 迁移脚本在 `seeds/` 目录

## 相关功能

- **管理员端**: 管理员可以在 AdminView 中进行相同的成绩编辑操作
- **成绩导出**: 所有导出的 Excel 都会使用最终成绩
- **成绩统计**: 课程平均分使用最终成绩计算
